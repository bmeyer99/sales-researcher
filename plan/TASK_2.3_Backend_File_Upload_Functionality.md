# Task 2.3: Backend - File Upload Functionality

**Phase:** Phase 2: Google Drive Integration
**Parent Plan:** [PROJECT_PLAN.md](PROJECT_PLAN.md)
**Status:** To Do
**Last Updated:** 2025-05-29

## 1. Description
Implement backend functionality to upload files (specifically text/markdown content generated by Gemini and web crawling) to a specified Google Drive folder using the user's OAuth tokens.

## 2. Detailed Steps / Implementation Notes

1.  **Extend Google Drive Service (`backend/services/google_drive_service.py`):**
    *   Add a new method to the `GoogleDriveService` (or as a standalone function using the service client).
    *   This method, let's call it `upload_text_file(file_name: str, file_content: str, folder_id: str, mime_type: str = 'text/markdown') -> str:`, will:
        *   Accept a `file_name` (e.g., "CompanyName_Overview.md"), the `file_content` (as a string), the target `folder_id` (obtained from Task 2.2), and an optional `mime_type`.
        *   **Prepare File Metadata:**
            ```python
            file_metadata = {
                'name': file_name,
                'parents': [folder_id] # Specify the parent folder
            }
            ```
        *   **Prepare Media Content:**
            *   The Google Drive API supports various upload types (simple, multipart, resumable). For text files of reasonable size, multipart upload is suitable.
            *   Use `googleapiclient.http.MediaIoBaseUpload` or `MediaInMemoryUpload`. For string content, `MediaInMemoryUpload` is convenient.
            ```python
            from googleapiclient.http import MediaInMemoryUpload
            import io

            # Convert string content to bytes
            content_bytes = file_content.encode('utf-8')
            fh = io.BytesIO(content_bytes)
            media_body = MediaInMemoryUpload(
                fh,
                mimetype=mime_type,
                resumable=True # Good practice for larger files or unreliable connections
            )
            ```
        *   **Execute Upload:**
            *   Use `drive_service.files().create()` with `body=file_metadata` and `media_body=media_body`.
            ```python
            created_file = drive_service.files().create(
                body=file_metadata,
                media_body=media_body,
                fields='id, name, webViewLink' # Get ID, name, and direct link of the uploaded file
            ).execute()
            return created_file # Or specific fields like created_file.get('id')
            ```
        *   Return information about the uploaded file (e.g., its ID, name, webViewLink).

2.  **Integration with Celery Tasks:**
    *   Celery tasks responsible for generating reports (Gemini overviews, competitor analysis, extracted markdown content) will call this `upload_text_file` method.
    *   They will pass the generated content, a descriptive filename, and the target `folder_id`.

3.  **File Naming Conventions:**
    *   Establish clear and descriptive naming conventions for uploaded files.
    *   Examples:
        *   `[CompanyName]_Overview_YYYYMMDD.md`
        *   `[CompanyName]_CompetitorAnalysis_YYYYMMDD.md`
        *   `[CompanyName]_MarketingAnalysis_YYYYMMDD.md`
        *   `[SourcePageTitle_or_URL_Slug]_Content.md`
    *   Ensure filenames are sanitized to avoid issues with invalid characters if necessary (though Google Drive is generally flexible).

4.  **Error Handling:**
    *   Handle potential errors during upload:
        *   Permissions issues (unlikely if `folder_id` is for a folder created by the app).
        *   File size limits (though text files should be fine).
        *   API errors from Google Drive.
        *   Network issues (resumable uploads help here).

## 3. Expected Output / Deliverables
*   A Python function/method in the backend that can upload a given string content as a file (e.g., Markdown or plain text) to a specified Google Drive folder ID.
*   The function should return details of the uploaded file, such as its ID and web view link.

## 4. Dependencies
*   Task 2.1: Backend - Google Drive API Client Setup (provides the `drive_service` client).
*   Task 2.2: Backend - Folder Creation/Validation (to get the `folder_id` where files will be uploaded).
*   User's authenticated Google credentials with `drive.file` scope.

## 5. Acceptance Criteria
*   Calling the `upload_text_file` function with valid content, filename, and folder ID successfully uploads the file to the user's Google Drive in the specified folder.
*   The uploaded file has the correct name, content, and MIME type.
*   The function returns the correct ID and/or link for the newly created file.
*   Errors during the upload process are handled or propagated correctly.

## 6. Estimated Effort (Optional)
*   Medium

## 7. Notes / Questions
*   **MIME Types:**
    *   For Markdown: `text/markdown` or `text/x-markdown`.
    *   For plain text: `text/plain`.
    *   Google Drive might automatically convert or preview based on content and extension.
*   **Resumable Uploads:** While `MediaInMemoryUpload` can be set to `resumable=True`, for very large files or truly robust resumable uploads, a more detailed implementation using `googleapiclient.http.ResumableUpload` might be needed, but this is likely overkill for text-based reports.
*   **File Overwriting:** The current `files().create()` approach will create new files. If overwriting is desired (e.g., updating a report), the logic would first need to search for an existing file by name in the folder, get its ID, and then use `drive_service.files().update(fileId=existing_file_id, media_body=media_body, ...)` instead. For this project, creating new files with potentially timestamped or unique names is simpler.